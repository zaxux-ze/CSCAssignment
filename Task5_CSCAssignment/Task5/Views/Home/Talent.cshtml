<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title></title>
    <link rel="stylesheet" href="~/searchTalentStart/mystyle.css" />
</head>
<body>
    <div id="searcharea">
        <label for="search">live search</label>
        <p>Enter the name or info about a speaker</p>
        <input type="search" name="search" id="search" placeholder="name or info" />
    </div>
    <div id="update"></div>
    <script src="~/searchTalentStart/jquery.js"></script>
</body>
</html>

@section Scripts
{
    <script>
        $(document).ready(function () {
           
            var keyNameDict = [];
            var keyNameLink = [];
            var talentData = [];
            var inddata;

            getTalentData();
            getBucketDataAndShortenLink();

            function KeyData(inKey, inKeyName) {
                this.KeyName = inKeyName;
                this.Key = inKey;
            }

            function getTalentData()
            {
                $.ajax({
                    type: 'GET',
                    url: '/api/talents/'
                }).done(function (data) {
                    for (var i = 0; i < data.length; i++) {
                        var list = [];
                        list.push(data[i].Name);
                        var indData = list.join(', ');
                        var firstPartOfName = indData.substr(0, indData.indexOf(' '));
                        talentData.push(firstPartOfName);
                    }
                })
            }

            function getBucketDataAndShortenLink()
            {
                $.ajax({
                    type: 'GET',
                    url: '/api/talents/getBucketObject'
                }).done(function (data, textStatus, jqXHR) {

                    for (var index = 0; index < data.length; index++) {
                        var keyName = data[index];

                        for (var a = 0; a < talentData.length; a++) {
                            var individualData = talentData[a];

                            if (keyName.indexOf(individualData) !== -1) {
                                keyNameDict.push({
                                    key: individualData,
                                    value: keyName
                                });
    
                                break;

                            }
                            else {
                                continue;
                            }
                        }
                    }
                    for (var c = 0; c < keyNameDict.length; c++) {
                        inddata = keyNameDict[c];

                        let keyNameData = new KeyData(inddata.key, inddata.value);

                        $.ajax({
                            type: 'POST',
                            url: '/api/talents/shortenLink',
                            contentType: 'application/x-www-form-urlencoded',
                            data: keyNameData
                        }).done(function (data) {
                            keyNameLink.push({
                                key: data.keyName,
                                value: data.link
                            });
                        })

                    }

                })
            }


            $('#search').keyup(function () {
                var urlForJson = "https://localhost:44367/api/talents";

                var searchField = $('#search').val();
                var myExp = new RegExp(searchField, "i");
                $.getJSON(urlForJson, function (data) {
                    var output = '<ul class="searchresults">';
                    $.each(data, function (key, val) {

                        if ((val.Name.search(myExp) != -1) ||
                            (val.Bio.search(myExp) != -1)) {
                            output += '<li>';
                            output += '<h2>' + val.Name + '</h2>';

                            for (var d = 0; d < keyNameLink.length; d++)
                            {
                                
                                inddata = keyNameLink[d];
                                var name = inddata.key;
                                var searchName = val.Name;

                                if (searchName.indexOf(name) !== -1) {
                                    output += '<img src=' + inddata.value + " alt=" + val.Name + '" />';
                                    output += '<p>' + val.Bio + '</p>';
                                    output += '</li>';
                                    break;
                                }
                                
                            }
                            
                        }
                    });
                    output += '</ul>';
                    $('#update').html(output);
                }); //get JSON
            });

        })

    </script>
}
